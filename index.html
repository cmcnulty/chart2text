<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>chart2text Demo</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f5f5;
    }

    h1 {
      color: #333;
      text-align: center;
    }

    .description {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
      border-left: 4px solid #2196F3;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin: 30px 0;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    canvas {
      max-width: 100%;
    }

    /* Visually hidden class for screen reader text */
    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .example-title {
      color: #555;
      margin-top: 40px;
      border-bottom: 2px solid #2196F3;
      padding-bottom: 10px;
    }

    code {
      background: #f4f4f4;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
  </style>
</head>
<body>
  <h1>chart2text Demo</h1>
  <p class="description">
    <strong>chart2text</strong> automatically generates natural language descriptions of charts for screen readers.
    The text descriptions are visually hidden but available to assistive technologies.
  </p>

  <!-- Example 1: Line Chart -->
  <h2 class="example-title">Example 1: Line Chart - Retirement Income</h2>
  <div class="chart-container">
    <canvas id="lineChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="lineDescription"></div>
  </div>

  <!-- Example 2: Bar Chart -->
  <h2 class="example-title">Example 2: Bar Chart - Quarterly Sales</h2>
  <div class="chart-container">
    <canvas id="barChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="barDescription"></div>
  </div>

  <!-- Example 3: Multi-line Chart -->
  <h2 class="example-title">Example 3: Multi-Dataset Line Chart</h2>
  <div class="chart-container">
    <canvas id="multiLineChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="multiLineDescription"></div>
  </div>

  <!-- Example 4: Bar Chart with Sequential Data (Trend Mode) -->
  <h2 class="example-title">Example 4: Bar Chart with Sequential Data - Using Trend Analysis</h2>
  <p style="margin: 10px 0; color: #666;">
    This bar chart shows data over time (ages 55-75). By setting <code>descriptor: 'trend'</code>,
    the plugin uses piecewise regression instead of treating each bar as an independent category.
  </p>
  <div class="chart-container">
    <canvas id="sequentialBarChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description (using trend analysis):</strong>
    <div id="sequentialBarDescription"></div>
  </div>

  <!-- Example 5: Pie Chart -->
  <h2 class="example-title">Example 5: Pie Chart - Department Budgets</h2>
  <p style="margin: 10px 0; color: #666;">
    Pie charts are automatically sorted from largest to smallest slice by default (use <code>sortPieSlices: false</code> to preserve original order).
  </p>
  <div class="chart-container">
    <canvas id="pieChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="pieDescription"></div>
  </div>

  <!-- Example 6: Monthly Data with 31 Days -->
  <h2 class="example-title">Example 6: Monthly Time Series - 31 Days of Order Volume</h2>
  <p style="margin: 10px 0; color: #666;">
    This example demonstrates handling larger datasets (31 data points). The synthesized data shows volume increasing during weekdays and decreasing on weekends, which the piecewise regression captures as distinct trend segments.
  </p>
  <div class="chart-container">
    <canvas id="monthlyChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="monthlyDescription"></div>
  </div>

  <!-- Example 7: Stacked Bar Chart -->
  <h2 class="example-title">Example 7: Stacked Bar Chart - Quarterly Revenue by Product</h2>
  <p style="margin: 10px 0; color: #666;">
    Stacked bar charts show multiple datasets where bars are stacked on top of each other. With <code>combineStacks: true</code>, the plugin describes the total combined values instead of each dataset separately, making the description more concise.
  </p>
  <div class="chart-container">
    <canvas id="stackedBarChart"></canvas>
  </div>
  <div class="description">
    <strong>Generated Description:</strong>
    <div id="stackedBarDescription"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Import map to resolve npm dependencies -->
  <script type="importmap">
    {
      "imports": {
        "segreg": "https://esm.sh/segreg@0.5.5"
      }
    }
  </script>

  <script type="module">
    // Import the plugin
    import { chart2text } from './dist/index.esm.js';

    // Register the plugin
    Chart.register(chart2text);

    // Example 1: Line Chart
    const lineCtx = document.getElementById('lineChart');
    const lineChart = new Chart(lineCtx, {
      type: 'line',
      data: {
        labels: [55, 60, 65, 70, 75],
        datasets: [{
          label: 'Monthly Income',
          data: [2500, 3200, 4000, 4200, 4100],
          borderColor: '#2196F3',
          backgroundColor: 'rgba(33, 150, 243, 0.1)',
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Retirement Income by Age'
          },
          chart2text: {
            datasetLabel: 'Monthly Retirement Income',
            xUnit: 'age',
            yUnit: 'dollars',
            yAxisCurrency: 'USD',
            useRounding: true
          }
        }
      }
    });

    // Show the description
    setTimeout(() => {
      const desc = document.querySelector('#lineChart-description');
      if (desc) {
        document.getElementById('lineDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 2: Bar Chart
    const barCtx = document.getElementById('barChart');
    const barChart = new Chart(barCtx, {
      type: 'bar',
      data: {
        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
        datasets: [{
          label: 'Sales',
          data: [45000, 52000, 48000, 61000],
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Quarterly Sales Performance'
          },
          chart2text: {
            datasetLabel: 'Quarterly Sales',
            yAxisCurrency: 'USD'
          }
        }
      }
    });

    setTimeout(() => {
      const desc = document.querySelector('#barChart-description');
      if (desc) {
        document.getElementById('barDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 3: Multi-line Chart
    const multiLineCtx = document.getElementById('multiLineChart');
    const multiLineChart = new Chart(multiLineCtx, {
      type: 'line',
      data: {
        labels: [2020, 2021, 2022, 2023, 2024],
        datasets: [
          {
            label: 'Product A',
            data: [30, 45, 55, 65, 70],
            borderColor: '#FF6384',
            tension: 0.4
          },
          {
            label: 'Product B',
            data: [20, 30, 40, 45, 48],
            borderColor: '#36A2EB',
            tension: 0.4
          }
        ]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Product Sales Over Time'
          },
          chart2text: {
            xUnit: 'year',
            yUnit: 'units sold',
            yAxisCurrency: undefined
          }
        }
      }
    });

    setTimeout(() => {
      const desc = document.querySelector('#multiLineChart-description');
      if (desc) {
        document.getElementById('multiLineDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 4: Sequential Bar Chart with Trend Analysis
    const sequentialBarCtx = document.getElementById('sequentialBarChart');
    const sequentialBarChart = new Chart(sequentialBarCtx, {
      type: 'bar',
      data: {
        labels: [55, 60, 65, 70, 75],
        datasets: [{
          label: 'Retirement Balance',
          data: [150000, 225000, 320000, 385000, 420000],
          backgroundColor: [
            'rgba(156, 39, 176, 0.8)',
            'rgba(103, 58, 183, 0.8)',
            'rgba(63, 81, 181, 0.8)',
            'rgba(33, 150, 243, 0.8)',
            'rgba(3, 169, 244, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Projected Retirement Balance by Age'
          },
          chart2text: {
            descriptor: 'trend',  // Force trend analysis for this sequential bar chart
            datasetLabel: 'Retirement Balance',
            xUnit: 'age',
            yUnit: 'dollars',
            yAxisCurrency: 'USD',
            useRounding: true
          }
        }
      }
    });

    setTimeout(() => {
      const desc = document.querySelector('#sequentialBarChart-description');
      if (desc) {
        document.getElementById('sequentialBarDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 5: Pie Chart with Sorted Slices
    const pieCtx = document.getElementById('pieChart');
    const pieChart = new Chart(pieCtx, {
      type: 'pie',
      data: {
        labels: ['Marketing', 'Development', 'Sales', 'Operations', 'HR', 'Legal', 'Support'],
        datasets: [{
          label: 'Department Budget',
          data: [45000, 120000, 85000, 60000, 35000, 25000, 40000],
          backgroundColor: [
            'rgba(255, 99, 132, 0.8)',
            'rgba(54, 162, 235, 0.8)',
            'rgba(255, 206, 86, 0.8)',
            'rgba(75, 192, 192, 0.8)',
            'rgba(153, 102, 255, 0.8)',
            'rgba(255, 159, 64, 0.8)',
            'rgba(199, 199, 199, 0.8)'
          ]
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Annual Department Budgets'
          },
          chart2text: {
            datasetLabel: 'Annual Department Budgets',
            yAxisCurrency: 'USD',
            sortPieSlices: true  // Default behavior - sorts largest to smallest
          }
        }
      }
    });

    setTimeout(() => {
      const desc = document.querySelector('#pieChart-description');
      if (desc) {
        document.getElementById('pieDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 6: Monthly Data (31 days) - Volume increases during weekdays, decreases on weekends
    // Generate 31 days of data starting from January 1, 2024
    function generateMonthlyData() {
      const labels = [];
      const data = [];
      const startDate = new Date(2024, 0, 1); // January 1, 2024

      // Base volume and daily variation
      let weekdayBase = 50;

      for (let day = 0; day < 31; day++) {
        const currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + day);

        const dayOfWeek = currentDate.getDay(); // 0 = Sunday, 6 = Saturday
        const dateStr = `${currentDate.getMonth() + 1}/${currentDate.getDate()}`;
        labels.push(dateStr);

        let volume;
        if (dayOfWeek === 0 || dayOfWeek === 6) {
          // Weekend: lower volume (30-40% of weekday volume)
          volume = weekdayBase * (0.3 + Math.random() * 0.1);
        } else {
          // Weekday: progressive increase Monday-Friday
          const weekNumber = Math.floor(day / 7);
          const dayInWeek = dayOfWeek; // 1=Mon, 2=Tue, ..., 5=Fri

          // Volume increases throughout the week
          const weekProgress = (dayInWeek / 5); // 0.2 on Monday, 1.0 on Friday
          volume = weekdayBase * (0.8 + weekProgress * 0.4);

          // Add monthly growth trend
          volume += weekNumber * 5;

          // Add some random variation
          volume += (Math.random() - 0.5) * 10;
        }

        data.push(Math.round(volume));
      }

      return { labels, data };
    }

    const monthlyData = generateMonthlyData();

    const monthlyCtx = document.getElementById('monthlyChart');
    const monthlyChart = new Chart(monthlyCtx, {
      type: 'line',
      data: {
        labels: monthlyData.labels,
        datasets: [{
          label: 'Daily Orders',
          data: monthlyData.data,
          borderColor: '#9C27B0',
          backgroundColor: 'rgba(156, 39, 176, 0.1)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Daily Order Volume - January 2024'
          },
          chart2text: {
            datasetLabel: 'Daily Order Volume',
            xUnit: 'date',
            yUnit: 'orders',
            useRounding: true
          }
        },
        scales: {
          x: {
            ticks: {
              maxTicksLimit: 10  // Show fewer labels for readability
            }
          }
        }
      }
    });

    setTimeout(() => {
      const desc = document.querySelector('#monthlyChart-description');
      if (desc) {
        document.getElementById('monthlyDescription').textContent = desc.textContent;
      }
    }, 500);

    // Example 7: Stacked Bar Chart
    const stackedBarCtx = document.getElementById('stackedBarChart');
    const stackedBarChart = new Chart(stackedBarCtx, {
      type: 'bar',
      data: {
        labels: ['Q1', 'Q2', 'Q3', 'Q4'],
        datasets: [
          {
            label: 'Software',
            data: [28000, 32000, 35000, 42000],
            backgroundColor: 'rgba(33, 150, 243, 0.8)'
          },
          {
            label: 'Hardware',
            data: [18000, 22000, 19000, 25000],
            backgroundColor: 'rgba(76, 175, 80, 0.8)'
          },
          {
            label: 'Services',
            data: [15000, 17000, 21000, 24000],
            backgroundColor: 'rgba(255, 152, 0, 0.8)'
          }
        ]
      },
      options: {
        responsive: true,
        scales: {
          x: {
            stacked: true
          },
          y: {
            stacked: true
          }
        },
        plugins: {
          title: {
            display: true,
            text: 'Quarterly Revenue by Product Category'
          },
          chart2text: {
            datasetLabel: 'Total Quarterly Revenue',
            yAxisCurrency: 'USD',
            useRounding: true,
            combineStacks: true  // Combine stacked values into totals
          }
        }
      }
    });

    // Function to update the display description
    function updateStackedBarDescription() {
      const desc = document.querySelector('#stackedBarChart-description');
      if (desc) {
        document.getElementById('stackedBarDescription').textContent = desc.textContent;
      }
    }

    // Initial update
    setTimeout(updateStackedBarDescription, 500);

    // Update when chart changes (e.g., legend click)
    const originalOnClick = stackedBarChart.options.plugins.legend?.onClick;
    if (!stackedBarChart.options.plugins.legend) {
      stackedBarChart.options.plugins.legend = {};
    }
    stackedBarChart.options.plugins.legend.onClick = function(e, legendItem, legend) {
      // Call the default Chart.js legend click handler
      if (originalOnClick) {
        originalOnClick.call(this, e, legendItem, legend);
      } else {
        // Default behavior: toggle dataset visibility
        const index = legendItem.datasetIndex;
        const chart = legend.chart;
        if (chart.isDatasetVisible(index)) {
          chart.hide(index);
        } else {
          chart.show(index);
        }
        chart.update();
      }

      // Update the description display after a short delay
      setTimeout(updateStackedBarDescription, 100);
    };
  </script>
</body>
</html>
